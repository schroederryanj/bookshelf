// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model Book {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(500)
  img         String   @db.VarChar(500)
  height      Float
  read          String?
  dateStarted   String?  @db.VarChar(100)
  dateFinished  String?  @db.VarChar(100)
  author        String?  @db.VarChar(500)
  pages       Int?
  genre       String?  @db.VarChar(255)
  description String?  @db.Text
  rating      Int?     // Legacy - to be removed after migration

  // Multi-factor rating system (1-5 scale each)
  ratingWriting       Int?
  ratingPlot          Int?
  ratingCharacters    Int?
  ratingPacing        Int?
  ratingWorldBuilding Int?
  ratingEnjoyment     Int?
  ratingRecommend     Int?
  ratingOverall       Float?            // Auto-calculated or manual override
  ratingOverrideManual Boolean @default(false)

  shelf       Int      @default(1)
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations for reading tracking
  readingProgress  ReadingProgress[]
  readingSessions  ReadingSession[]

  @@index([title])
  @@index([author])
  @@index([read])
  @@index([shelf])
  @@index([position])
  @@index([rating])
  @@index([ratingOverall])
}

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

// Reading Progress Tracking Models

enum ReadingStatus {
  NOT_STARTED
  READING
  COMPLETED
  DNF // Did Not Finish
}

enum GoalType {
  BOOKS_PER_MONTH
  BOOKS_PER_YEAR
  PAGES_PER_DAY
}

model ReadingProgress {
  id              Int           @id @default(autoincrement())
  bookId          Int
  userId          String        @default("default") @db.VarChar(255) // For future multi-user support
  status          ReadingStatus @default(NOT_STARTED)
  progressPercent Float         @default(0)
  currentPage     Int           @default(0)
  totalPages      Int?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@index([completedAt])
}

model ReadingSession {
  id         Int       @id @default(autoincrement())
  bookId     Int
  userId     String    @default("default") @db.VarChar(255)
  startTime  DateTime  @default(now())
  endTime    DateTime?
  pagesRead  Int       @default(0)
  duration   Int?      // Duration in seconds
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([startTime])
}

model ReadingGoal {
  id        Int      @id @default(autoincrement())
  userId    String   @default("default") @db.VarChar(255)
  goalType  GoalType
  target    Int
  current   Int      @default(0)
  period    String   @db.VarChar(50) // e.g., "2024-01" for monthly, "2024" for yearly
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, goalType, period])
  @@index([userId])
  @@index([goalType])
  @@index([period])
}

// Gamification / Achievements System

enum AchievementType {
  MILESTONE     // Books/pages count achievements
  STREAK        // Reading streak achievements
  DIVERSITY     // Genre diversity achievements
  SPEED         // Reading speed achievements
  COMPLETIONIST // Author/series completion achievements
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum AchievementCategory {
  READING_VOLUME   // Total books/pages read
  READING_STREAK   // Consecutive days reading
  GENRE_DIVERSITY  // Different genres read
  READING_SPEED    // Books per time period
  AUTHOR_LOYALTY   // Multiple books by same author
  TIME_INVESTMENT  // Total reading time
}

model Achievement {
  id          Int                 @id @default(autoincrement())
  name        String              @db.VarChar(255)
  description String              @db.Text
  icon        String              @db.VarChar(100) // Emoji or icon identifier
  category    AchievementCategory
  type        AchievementType
  tier        AchievementTier
  requirement Json                // Flexible criteria (e.g., { "books": 10 }, { "streak": 7 }, { "genres": 5 })
  points      Int                 @default(0)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relation to user achievements
  userAchievements UserAchievement[]

  @@unique([name])
  @@index([category])
  @@index([type])
  @@index([tier])
  @@index([isActive])
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        String      @default("default") @db.VarChar(255)
  achievementId Int
  earnedAt      DateTime    @default(now())
  progress      Float       @default(0) // 0-100 for partial completion tracking
  isComplete    Boolean     @default(false)
  metadata      Json?       // Additional data about how achievement was earned
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([earnedAt])
  @@index([isComplete])
}
